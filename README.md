# Chassi SRE

## Topics
- Resilience
  - [Retry &#x1F517;](README-RETRY.md "Readme for Retry Structure")
  - [Circuit Breaker &#x1F517;](README-CB.md "Readme for Circuit Breaker Structure")
- [Project Strutucre](#project-strutucre "Project Strutucre")
  - [Pre-Requires](#pre-requires "Pre-Requires")
  - [Clean Architecture](#clean-architecture "Clean Architecture")
  - [Packages Structure](#packages-structure "Packages Structure")
- [Configurations](#configurations "Configurations")
- [Running application](#running-application "Running application")
  - [Running apllication via ide](#running-apllication-via-ide "Running apllication via ide")
  - [Removing apllication and reset data on Mongo](#removing-apllication-and-reset-data-on-mongo "Removing apllication and reset data on Mongo")
  - [Building application](#building-application "Building application")
  - [Running sonarqube](#running-sonarqube "Running sonarqube")
  - [Running sonarqube with Mutation Coverage](#running-sonarqube-with-mutation-coverage "Running sonarqube with Mutation Coverage")
- [Running stress tests](#running-stress-tests "Running stress tests")
  - [Docker run script](#docker-run-script "Docker run script")
  - [Client tests script](#client-tests-script "Client tests script")
- [Troubleshooting](#troubleshooting "Troubleshooting")


## Project Strutucre
### Pre-Requires
- JDK 11
- Maven 3.6.0
- Docker ([Install](https://docs.docker.com/engine/install/ubuntu/ "Install") | [Configure](https://docs.docker.com/v17.09/engine/installation/linux/linux-postinstall/ "Configure"))
- docker-compose ([Install](https://docs.docker.com/compose/install/ "Install"))

### Clean Architecture
![Alt text](./docs/clean_architecture.png "Clean Architecture Cone")

### Packages structure
![Alt text](./docs/packages_clean_architecture.png "Clean Architecture Cone")

* businessrule -> Use case, i.e. the application's business rules.
    - dto -> Middle classes created to group multiple objects into one.
    - exception -> Package where the custom exceptions is.
    - gateway -> Package where the interface calls the repository to connect external applications, i.e. usecase call the database.
    - message -> message service used by the validator, e.g. read the error message and get a appropriate message to that error.
    - usecase -> Package where all usecase is.
    - validator -> Package with custom validations, e.g. AutoInsuranceValidator is used to validate the input params in the API .

  
* domain -> Domain entities, i.e. related to the domain's business rules.


* external -> Items related to the most external part of the application, i.e. items related to the application it self.
    - configuration -> Items related to the application's configuration in general, i.e. database configuration, cache configuration.


* interfaceadapter -> Items related to the user's access, i.e. Controllers, Gateways, Repositories and Delegate.
    - delegate -> Intended to implement the delegate classes auto generated by the openAPI generator, i.e. it delegates the responsability to the usecase.
    - gateway -> Implements the gateway interface used in the businessrule package.
    - mapper -> Used to suit the domain object comming from the database into the response.
    - repository -> Used to call and get data from the database.
    - util -> Package with utils used in the application.

## + Configurations
```bash
Make sure you have setup your local Git Hooks:
This will make sure your commit messages follow our Conventional Commits Specification.

> git config core.hooksPath .githooks
```

## Running application

```bash
docker-compose -f misc/docker/docker-compose.yml up -d

./mvnw spring-boot:run -Dspring-boot.run.profiles=development  # or via ide

```

### Running apllication via ide
- Run Application 
  - Edit Configurations:
    Add parameter in 'Environment variables:' 
      spring.profiles.active=development
  
    ![Alt text](./docs/application_environment.png "Edit Configuration / Environment variables")


### Removing apllication and reset data on Mongo

```bash
docker-compose -f misc/docker/docker-compose.yml down -v
```

- Mongo Express ([mongo-express](http://localhost:8086 "mongo-express"))
  - user: 'dev', pwd: 'dev!'
  - Note: To access Mongo, it's not necessary run the application, just the Docker.

- Swagger-ui ([swagger](http://localhost:8080/swagger-ui/#/ "swagger"))
- API docs ([api-docs](http://localhost:8080/v3/api-docs "api-docs"))
- Actuator ([Actuator](http://localhost:8080/actuator "Actuator"))
- Health ([Health](http://localhost:8080/actuator/health "Health"))
- Application Info(git+build) ([Info](http://localhost:8080/actuator/info "Info"))
- Application Environment variable ([Env](http://localhost:8080/actuator/env "Env"))

### Building application

```
docker build --file Dockerfile -t opin-srv-app .

docker run -p 8080:8080 opin-srv-app
```

- Running sonar analysis local
  `./mvnw sonar:sonar`

- Run PMD Linter rules with CPD(Copy Paste Detection)
  `./mvnw pmd:pmd pmd:cpd`
 
### Running sonarqube

- The SonarQube container is created when docker-compose is run

``` docker-compose -f misc/docker/docker-compose.yml up -d ```

- To run the sonarqube it needs the token, it can be found on localhost:9090, at the profile -> My account -> Security and generate token

```
mvn --batch-mode verify sonar:sonar -Dsonar.host.url=http://localhost:9000 -Dsonar.login="admin" -Dsonar.password="dev!"
```

### Running sonarqube with Mutation Coverage

```
mvn clean --batch-mode verify org.pitest:pitest-maven:mutationCoverage  sonar:sonar -Dsonar.host.url=http://localhost:9000 -Dsonar.login="admin" -Dsonar.password="dev!"
```

- Run sonarqube with minimum coverage

```
mvn clean --batch-mode verify org.pitest:pitest-maven:mutationCoverage sonar:sonar -Dsonar.host.url=http://localhost:9000 -Dsonar.login="admin" -Dsonar.password="dev!" 
-DmutationThreshold=90
```

## Running stress tests
"In order to run the stress test, all Docker containers must be up and running ([Running application](#running-application)).

Two separate scripts have been created for this purpose, 'docker_run.sh' and 'client_test.sh'.

- **docker_run.sh**: Creates a new image of the current application, with memory and CPU limitations based on the provided parameters, enabling the determination of the best application configuration.

- **client_test.sh**: Executes multiple concurrent calls to the application endpoint, putting it under maximum stress.

### Docker run script
Arguments
- -m
  * The maximum memory allocation for the POD and JVM.
  * Default: 512m
- -r
  * The starting memory capacity (reserved memory) for the POD and JVM.
  * Default: 256m
- -b
  * This flag determines whether to build the image during script execution. If you wish to modify any of the other parameters (e.g. memory), this option must be set to TRUE.
  * Default: true
- -c
  * Limits the amount of CPU allocated to the POD, with the maximum amount not exceeding the number of cores on the host machine.
  * Default: no limit

Usage:
```bash
bash misc/docker/docker_run.sh -b true -r 256m -m 512m -c 4
```

### Client tests script
Once the 'docker_run.sh' script has been executed, the container will be up and running, ready for use. At this point, the 'client_test.sh' script can be modified to perform calls to the target address. Please note that the script is just an example and you are free to customize and adapt it to your specific application needs.

Usage:
```bash
bash misc/docker/client_test.sh
```

## Troubleshooting

- Install docker

```bash
sudo apt-get update -y
 
sudo apt-get purge docker-ce docker-ce-cli containerd.io -y
 
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo apt-get install docker-compose
```

- Docker permission denied

```bash
sudo usermod -aG docker $(whoami)
sudo chmod 777 /var/run/docker.sock
docker ps

  ```

- With Redis UP, to access redis-cli inside container run the following command:

```sh
docker exec -it <nome_container> redis-cli
```

- Redis-cli: To monitor calls:

```sh
monitor
```

- Redis-cli: To list all keys stored:

```sh
keys *
```

- Redis-cli: To get a key value:

```sh
GET "key"
```

- Redis-cli: To see the time-to-live of a key:

```sh
TTL "key"
```

- Redis-cli: To clear all keys

```sh
FLUSHALL
```