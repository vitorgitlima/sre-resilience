server:
  port: ${SERVER_PORT:8080}
  servlet.context-path: ${APPLICATION_CONTEXT:}

application:
  timeZone: GMT-3

spring:
  main.allow-bean-definition-overriding: true
  messages:
    encoding: ISO-8859-1
  application:
    name: Open Insurance - Fornecimento de Produtos Residenciais
  profiles:
    active: test
  redis:
    host: ${REDIS_TEST_HOST:localhost}
    port: ${REDIS_TEST_PORT:6378}
    password: ${REDIS_TEST_PASSWORD:}

mongo-properties:
  url: ${MONGODB_URL:mongodb://${mongo-properties.username}:${mongo-properties.password}@${mongo-properties.host}:${mongo-properties.port}/${mongo-properties.database}?${mongo-properties.query-string}}
  host: ${MONGO_HOST:localhost}
  port: ${MONGO_PORT:27017}
  database: ${MONGO_DB:opin-db-apis}
  username: ${MONGO_USER:admin}
  password: ${MONGO_PASS:admin!}
  query-string: ${MONGO_QUERY_STRING:retryWrites=true&w=majority}
  connection-pool-max-connection-life-time: 3
  connection-pool-min-size: ${MONGO_MIN_CONNECTIONS:75}
  connection-pool-max-size: ${MONGO_MAX_CONNECTIONS:150}
  connection-pool-maintenance-frequency: 1
  connection-pool-maintenance-initial-delay: 5
  connection-pool-max-connection-idle-time: 1
  connection-pool-max-wait-time: 15

info:
  application:
    name: ${spring.application.name}
    version: '@project.version@'
    swaggerVersion: 1.1.0


resilience4j.retry:
  configs:
    default:
      maxAttempts: 3
      waitDuration: 3s
      failAfterMaxAttempts: true
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
      ignoreExceptions:
        - io.github.resilience4j.circuitbreaker.CallNotPermittedException
  instances:
    cosmoRetry:
      baseConfig: default
      maxAttempts: 10
      waitDuration: 2s
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
        - org.springframework.dao.DataAccessResourceFailureException
        - com.mongodb.MongoSocketOpenException
        - java.net.ConnectException
    apiRetry:
      baseConfig: default
      waitDuration: 5s
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
        - org.springframework.web.client.HttpServerErrorException

resilience4j.circuitbreaker:
  configs:
    default:
      registerHealthIndicator: true
      failure-rate-threshold: 50 # Threshold de falhas para ir para estado de "Aberto", em porcentagem.
      minimum-number-of-calls: 5  # Número de chamadas mínimas que são necessárias antes do CircuitBreaker poder calcular o error-rate. Se o número for 10, então ao menos 10 requisições tem que ser armazenadas para que seja calculado o valor da taxa de erro
      automatic-transition-from-open-to-half-open-enabled: true # Dispara um thread que faz a transição quando o tempo terminar. Caso seja false, aguarda uma nova request para mudar de status
      wait-duration-in-open-state: 50s # Tempo de espera no estado "Aberto". Será movido para o estado de "Semi-Aberto" após esse tempo
      permitted-number-of-calls-in-half-open-state: 3 # Número máximo de requisições permitidas quando no estado "Semi-Aberto". As demais requisições serão rejeitadas com CallNotPermittedException, até que todas as chamadas permitidas sejam concluídas.
      sliding-window-size: 10 # Tamanho da janela que é usada para registrar o resultado das chamadas quando o circuito esta fechado (quantas chamadas ele memoriza). Esse valor precisa ser maior que os valores de análise. Caso seja menor, vai sobrescrever o valor de requisições minimas necessárias
      sliding-window-type: count_based # COUNT_BASED ou TIME_BASED. Se for TIME, os segundos das ultimas requisições serão armazenados para cálculos
  instances:
    cosmoCircuitBreaker:
      baseConfig: default
      failure-rate-threshold: 90
      minimum-number-of-calls: 15
      sliding-window-size: 20
    apiCircuitBreaker:
      baseConfig: default
      automatic-transition-from-open-to-half-open-enabled: false