server:
  port: 0
  servlet.context-path: ${APPLICATION_CONTEXT:}

application:
  timeZone: GMT-3

spring:
  main.allow-bean-definition-overriding: true
  messages:
    encoding: ISO-8859-1
  application:
    name: Open Insurance - Fornecimento de Produtos Residenciais
  profiles:
    active: test
  cache:
    type: none

info:
  application:
    name: ${spring.application.name}
    version: '@project.version@'
    swaggerVersion: 1.1.0


resilience4j.retry:
  configs:
    default:
      maxAttempts: 3
      waitDuration: 3s
      failAfterMaxAttempts: true
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
      ignoreExceptions:
        - io.github.resilience4j.circuitbreaker.CallNotPermittedException
  instances:
    cosmoRetry:
      baseConfig: default
      maxAttempts: 10
      waitDuration: 2s
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
        - org.springframework.dao.DataAccessResourceFailureException
        - com.mongodb.MongoSocketOpenException
        - java.net.ConnectException
    apiRetry:
      baseConfig: default
      waitDuration: 5s
      retryExceptions:
        - br.com.bradescoseguros.opin.businessrule.exception.RetriableBaseException
        - org.springframework.web.client.HttpServerErrorException
    apiBulkhead:
      baseConfig: default
      maxAttempts: 2
      waitDuration: 2s
      retryExceptions:
        - io.github.resilience4j.bulkhead.BulkheadFullException
        - org.springframework.web.client.HttpServerErrorException
    apiTimeLimiter:
      baseConfig: default
      waitDuration: 2s
      retryExceptions:
        - br.com.bradescoseguros.opin.interfaceadapter.exception.TimeOutException


sre.resilience.retry.throw-sre-max-retries-exceed: true

resilience4j.circuitbreaker:
  configs:
    default:
      registerHealthIndicator: true
      failure-rate-threshold: 100 # Threshold de falhas para ir para estado de "Aberto", em porcentagem.
      minimum-number-of-calls: 3  # Número de chamadas mínimas que são necessárias antes do CircuitBreaker poder calcular o error-rate. Se o número for 10, então ao menos 10 requisições tem que ser armazenadas para que seja calculado o valor da taxa de erro
      automatic-transition-from-open-to-half-open-enabled: true # Dispara um thread que faz a transição quando o tempo terminar. Caso seja false, aguarda uma nova request para mudar de status
      wait-duration-in-open-state: 50s # Tempo de espera no estado "Aberto". Será movido para o estado de "Semi-Aberto" após esse tempo
      permitted-number-of-calls-in-half-open-state: 3 # Número máximo de requisições permitidas quando no estado "Semi-Aberto". As demais requisições serão rejeitadas com CallNotPermittedException, até que todas as chamadas permitidas sejam concluídas.
      sliding-window-size: 3 # Tamanho da janela que é usada para registrar o resultado das chamadas quando o circuito esta fechado (quantas chamadas ele memoriza). Esse valor precisa ser maior que os valores de análise. Caso seja menor, vai sobrescrever o valor de requisições minimas necessárias
      sliding-window-type: count_based # COUNT_BASED ou TIME_BASED. Se for TIME, os segundos das ultimas requisições serão armazenados para cálculos
  instances:
    cosmoCircuitBreaker:
      baseConfig: default
      failure-rate-threshold: 90
      minimum-number-of-calls: 15
      sliding-window-size: 20
    apiCircuitBreaker:
      baseConfig: default
      automatic-transition-from-open-to-half-open-enabled: false
      recordExceptions:
        - org.springframework.web.client.HttpServerErrorException


resilience4j.bulkhead:
  instances:
    semaphoreBulkhead:
      maxConcurrentCalls: 2
      maxWaitDuration: 1s

resilience4j:
  thread-pool-bulkhead:
    configs:
      default:
        maxThreadPoolSize: 1
        coreThreadPoolSize: 1
        queueCapacity: 1
        keepAliveDuration: 20
    instances:
      bulkheadInstance:
        baseConfig: default
        maxThreadPoolSize: 1
        coreThreadPoolSize: 1
        queueCapacity: 1
        keepAliveDuration: 20


resilience4j.timelimiter:
  configs:
    default:
      timeoutDuration: 2s
      cancelRunningFuture: true
  instances:
    limiterApi:
      baseConfig: default
    limiterDb:
      baseConfig: default

# Definições de Feature Toggle
feature-management:
  feature-a: true
  feature-b: true
  feature-c: true